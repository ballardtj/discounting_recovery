---
title: "Results of maximum likelihood modeling of Manos' delay discounting data"
output:
  html_document:
    df_print: paged
---

```{r echo=FALSE, message=FALSE,warning=FALSE,results='asis'}
library(tidyverse)

model_names = c(hyperbolic = 'Hyperbolic model',
                exponential = 'Exponential model',
                hyperbolic_gm = 'Hyperbolic model (Green & Myerson version)',
                prop_diff = 'Proportional difference model',
                tradeoff = 'Tradeoff model',
                ITCH = 'ITCH model',
                const_sens = 'Constant Sensitivity Model (Ebert & Prelec, 2007)',
                mazur1987 = 'Hyperboloid Model (Mazur, 1987)',
                loewenstein1992 = "Loewenstein & Prelec's (1992) Model",
                mcclure2007 = "Double Exponential Model (McClure et al., 2007)",
                killeen2009 = "Additive Utility Model (Killeen, 2009)")

plot_pp = function(dat_tmp){
  dat_pl = dat_tmp %>%
    group_by(amount,delay) %>%
    summarise(obs = mean(choose_a),
              obs_se = sd(choose_a)/sqrt(length(choose_a)),
              pred = mean(p_a))
  
  print(
    ggplot(dat_pl,aes(x=delay)) +
      geom_point(aes(y=obs),colour="red") +
      geom_errorbar(aes(ymin=obs-obs_se,ymax=obs+obs_se),colour="red") +
      geom_line(aes(y=pred),colour="blue") +
      facet_wrap(~amount)
  )
}

get_bic = function(dat_tmp){
  #make sure there are no cases where p_a = 0 or 1
  p_a = pmin(pmax(dat_tmp$p_a,0.001),0.999) 
  #calculate summed log likelihood
  lnl = sum(log(dat_tmp$choose_a*p_a + (1-dat_tmp$choose_a)*(1-p_a)))
  #compute number of parameters (based on how many columns are between observed choice and predicted choice)
  nparms = grep("p_a",names(dat_tmp))-grep("choose_a",names(dat_tmp)) - 1
  #compute bic
  bic = log(length(p_a))*nparms - 2*lnl 
  return(c(lnl=lnl,nparms=nparms,bic=bic))
}

#output for storing fit stats
output=list()
ctr=0


for (i in 1:length(model_names)){
  cat('\n')  
  cat("# ",model_names[i])
  
  load(file=paste0("data/derived/fit_ML_", names(model_names)[i],".RData"))
  
  #print(
    plot_pp(dat_tmp)
  #)
  ctr=ctr+1
  output[[ctr]]=get_bic(dat_tmp)
  cat('\n') 
}
```


# Model Comparison
```{r echo=FALSE}
library(knitr)

results=t(as.data.frame(output))
results2 = as.data.frame(cbind(model_names,results))
results3 = results2 %>%
  mutate(lnl = as.numeric(as.character(lnl)),
         nparms = as.numeric(as.character(nparms)),
         bic = as.numeric(as.character(bic))) %>%
  arrange(bic)
kable(results3,caption="Results of Model Comparisons")

```
